<h1 class="text-2xl font-semibold mb-2">Run Details</h1>
<p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Run: <span class="font-mono"><%= run.id %></span></p>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
  <div class="p-4 bg-white border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">
    <div class="text-sm text-gray-500 dark:text-gray-400">Status</div>
    <div class="mt-1"><span class="px-2 py-1 rounded text-xs <%= run.status === 'failed' ? 'bg-red-100 text-red-800' : run.status === 'finished' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800' %>"><%= run.status %></span></div>
  </div>
  <div class="p-4 bg-white border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">
    <div class="text-sm text-gray-500 dark:text-gray-400">Started</div>
    <div class="mt-1"><%= formatDateTimeUK(run.startedAt) %></div>
  </div>
  <div class="p-4 bg-white border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">
    <div class="text-sm text-gray-500 dark:text-gray-400">Finished</div>
    <div class="mt-1"><%= formatDateTimeUK(run.finishedAt) %></div>
  </div>
</div>

<h2 class="text-xl font-semibold mb-2">Log</h2>
<% const allLogs = Array.isArray(run.logs) ? run.logs : []; %>
<% const logLimitRaw = String((query && query.logLimit) || '200').trim().toLowerCase(); %>
<% const maxShow = logLimitRaw === 'all' ? null : Math.max(1, Number.parseInt(logLimitRaw, 10) || 200); %>
<% const startIdx = maxShow === null ? 0 : Math.max(0, allLogs.length - maxShow); %>
<% const runLogs = allLogs.slice(startIdx); %>
<form method="get" class="mb-3 flex items-center gap-2">
  <% if (mongoCollection) { %><input type="hidden" name="mongoCollection" value="<%= mongoCollection %>" /><% } %>
  <% if (mongoType) { %><input type="hidden" name="mongoType" value="<%= mongoType %>" /><% } %>
  <label for="logLimit" class="text-xs text-gray-500 dark:text-gray-400">Show</label>
  <select id="logLimit" name="logLimit" class="text-xs border border-gray-200 rounded px-2 py-1 dark:bg-gray-800 dark:border-gray-700" onchange="this.form.submit()">
    <option value="50" <%= logLimitRaw === '50' ? 'selected' : '' %>>50</option>
    <option value="100" <%= logLimitRaw === '100' ? 'selected' : '' %>>100</option>
    <option value="200" <%= (logLimitRaw === '200' || logLimitRaw === '') ? 'selected' : '' %>>200</option>
    <option value="all" <%= logLimitRaw === 'all' ? 'selected' : '' %>>All</option>
  </select>
</form>
<% if (runLogs.length === 0) { %>
  <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">No log entries recorded for this run.</p>
<% } else { %>
  <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">
    Showing <%= runLogs.length %> of <%= allLogs.length %> entries.
  </p>
  <div class="relative overflow-x-auto shadow-md sm:rounded-lg mb-6">
    <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
      <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
        <tr>
          <th class="px-6 py-3">Time</th>
          <th class="px-6 py-3">Level</th>
          <th class="px-6 py-3">Stage</th>
          <th class="px-6 py-3">Message</th>
        </tr>
      </thead>
      <tbody>
        <% runLogs.forEach((l, idx) => { %>
          <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
            <td class="px-6 py-4 whitespace-nowrap"><%= formatDateTimeUK(l.ts) %></td>
            <td class="px-6 py-4"><span class="font-mono text-xs"><%= l.level %></span></td>
            <td class="px-6 py-4"><span class="font-mono text-xs"><%= l.stage || '—' %></span></td>
            <td class="px-6 py-4">
              <div><%= l.message %></div>
              <% if (l.meta) { %>
                <details class="mt-1">
                  <summary class="cursor-pointer text-xs text-gray-500 dark:text-gray-400">meta</summary>
                  <pre class="overflow-auto bg-gray-50 dark:bg-gray-800 p-2 rounded text-xs"><%= JSON.stringify(l.meta, null, 2) %></pre>
                </details>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
<% } %>

<h2 class="text-xl font-semibold mb-2">Mongo</h2>
<% const mongo = run?.summary?.mongo || null; %>
<% if (!mongo) { %>
  <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">No Mongo summary recorded for this run.</p>
<% } else { %>
  <div class="relative overflow-x-auto shadow-md sm:rounded-lg mb-6">
    <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
      <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
        <tr>
          <th class="px-6 py-3">Collection</th>
          <th class="px-6 py-3">Upserted (Added)</th>
          <th class="px-6 py-3">Matched</th>
          <th class="px-6 py-3">Modified</th>
          <th class="px-6 py-3">Attempted Ops</th>
          <th class="px-6 py-3">Affected</th>
        </tr>
      </thead>
      <tbody>
        <% Object.entries(mongo).forEach(([name, s]) => { %>
          <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
            <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white"><%= name %></th>
            <td class="px-6 py-4">
              <% const hasUpsertDocs = (run?.summary?.mongoUpserts?.[name]?.filters || []).length > 0; %>
              <% if ((s?.upserted ?? 0) > 0) { %>
                <a class="text-blue-600 hover:underline" href="/history/<%= run.id %>?mongoCollection=<%= encodeURIComponent(name) %>&mongoType=upserted#mongo-upserted"><%= s?.upserted ?? 0 %></a>
                <% if (!hasUpsertDocs) { %>
                  <span class="ml-2 text-xs text-gray-500 dark:text-gray-400">(drilldown may require a newer run)</span>
                <% } %>
              <% } else { %>
                <%= s?.upserted ?? 0 %>
              <% } %>
            </td>
            <td class="px-6 py-4"><%= s?.matched ?? 0 %></td>
            <td class="px-6 py-4"><%= s?.modified ?? 0 %></td>
            <td class="px-6 py-4"><%= s?.attemptedOps ?? 0 %></td>
            <td class="px-6 py-4"><%= s?.affected ?? 0 %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <% if (mongoCollection && mongoType === 'upserted') { %>
    <div id="mongo-upserted" class="mb-6 scroll-mt-24">
      <h3 class="text-lg font-semibold mb-2">Upserted Docs: <span class="font-mono text-sm"><%= mongoCollection %></span></h3>
      <% if (mongoDocsSource) { %>
        <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">Source: <span class="font-mono"><%= mongoDocsSource %></span></p>
      <% } %>
      <% if (mongoDocsError) { %>
        <p class="text-sm text-red-700 dark:text-red-400"><%= mongoDocsError %></p>
      <% } else if (!mongoDocs) { %>
        <p class="text-sm text-gray-500 dark:text-gray-400">Loading…</p>
      <% } else if (mongoDocs.length === 0) { %>
        <p class="text-sm text-gray-500 dark:text-gray-400">No documents found for this run.</p>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">This view shows docs captured as inserted for the run (via bulk upsert metadata or per-run insert tags).</p>
      <% } else { %>
        <div class="space-y-3">
          <% const keyFor = (doc) => {
            if (!doc) return '';
            if (doc.code) return `code:${doc.code}`;
            if (typeof doc.number !== 'undefined' && doc.number !== null) return `number:${doc.number}`;
            if (doc._id) return `_id:${doc._id}`;
            return '';
          }; %>
          <% mongoDocs.forEach((doc, i) => { %>
            <% const k = keyFor(doc); %>
            <div id="mongo-doc-<%= i %>" class="border border-gray-200 rounded-lg dark:border-gray-700">
              <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-t-lg">
                <div class="text-sm">
                  <span class="font-semibold">Doc</span>
                  <% if (k) { %><span class="ml-2 font-mono text-xs text-gray-500"><%= k %></span><% } %>
                </div>
                <div class="text-xs text-gray-500 flex items-center gap-3">
                  <a class="text-blue-600 hover:underline relative z-10" href="#mongo-doc-<%= i %>">Link</a>
                </div>
              </div>
              <div class="p-3">
                <pre class="overflow-auto bg-gray-50 dark:bg-gray-800 p-3 rounded text-xs"><%= JSON.stringify(doc, null, 2) %></pre>
              </div>
            </div>
          <% }) %>
        </div>
      <% } %>
    </div>
  <% } %>
<% } %>

<h2 class="text-xl font-semibold mb-2">Changes</h2>
<% if (!run.changes || run.changes.length === 0) { %>
  <p class="text-sm text-gray-500 dark:text-gray-400">No changes recorded for this run.</p>
<% } else { %>
  <div class="space-y-3">
    <% run.changes.forEach((c, idx) => { %>
      <div id="change-<%= c.id %>" class="border border-gray-200 rounded-lg dark:border-gray-700 scroll-mt-24">
        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-t-lg">
          <div class="text-sm">
            <span class="font-semibold"><%= c.entityType %></span>
            <span class="ml-2 font-mono text-xs text-gray-500"><%= c.entityId %></span>
            <span class="ml-2 px-2 py-0.5 rounded text-xs <%= c.action === 'delete' ? 'bg-red-100 text-red-800' : c.action === 'create' ? 'bg-green-100 text-green-800' : c.action === 'update' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800' %>"><%= c.action %></span>
          </div>
          <div class="text-xs text-gray-500 flex items-center gap-3">
            <a class="text-blue-600 hover:underline relative z-10" href="#change-<%= c.id %>">Link</a>
            <span><%= formatDateTimeUK(c.ts) %></span>
          </div>
        </div>
        <div class="p-3">
          <% if (c.reason) { %>
            <p class="mb-2 text-sm"><span class="font-medium">Why:</span> <%= c.reason %></p>
          <% } %>
          <div id="accordion-<%= idx %>" data-accordion="collapse" class="w-full">
            <h2 id="acc-head-<%= idx %>">
              <button type="button" class="flex items-center justify-between w-full p-2 font-medium text-gray-500 border border-gray-200 rounded-t-xl focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-800 dark:border-gray-700 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 gap-3" data-accordion-target="#acc-body-<%= idx %>" aria-expanded="false" aria-controls="acc-body-<%= idx %>">
                <span>Details</span>
                <svg data-accordion-icon class="w-3 h-3 rotate-180 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/>
                </svg>
              </button>
            </h2>
            <div id="acc-body-<%= idx %>" class="hidden" aria-labelledby="acc-head-<%= idx %>">
              <div class="p-3 border border-gray-200 dark:border-gray-700">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">
                  <div>
                    <div class="font-semibold mb-1">Before</div>
                    <pre class="overflow-auto bg-gray-50 dark:bg-gray-800 p-2 rounded"><%= JSON.stringify(c.before, null, 2) %></pre>
                  </div>
                  <div>
                    <div class="font-semibold mb-1">After</div>
                    <pre class="overflow-auto bg-gray-50 dark:bg-gray-800 p-2 rounded"><%= JSON.stringify(c.after, null, 2) %></pre>
                  </div>
                </div>
                <% if (c.diff) { %>
                  <div class="mt-3">
                    <div class="font-semibold mb-1">Diff</div>
                    <pre class="overflow-auto bg-gray-50 dark:bg-gray-800 p-2 rounded"><%= JSON.stringify(c.diff, null, 2) %></pre>
                  </div>
                <% } %>
                <div class="mt-3 flex items-center gap-2">
                  <% if (!c.reverted) { %>
                    <form method="post" action="/history/<%= run.id %>/revert/<%= c.id %>">
                      <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>" /><% } %>
                      <input type="hidden" name="note" value="Manual revert requested" />
                      <button class="text-white bg-amber-600 hover:bg-amber-700 focus:ring-4 focus:outline-none focus:ring-amber-300 font-medium rounded-lg text-xs px-3 py-1.5 dark:bg-amber-500 dark:hover:bg-amber-600 dark:focus:ring-amber-800" type="submit">Mark Reverted</button>
                    </form>
                  <% } else { %>
                    <span class="px-2 py-1 rounded text-xs bg-gray-100 text-gray-800">Reverted</span>
                    <% if (c.revertNote) { %><span class="text-xs text-gray-500">— <%= c.revertNote %></span><% } %>
                  <% } %>
                  <form method="post" action="/pull" onsubmit="return false;">
                    <button type="button" class="text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-xs px-3 py-1.5 dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-800" onclick='(function(){ const t = (document.querySelector("meta[name=csrf-token]")||{}).content || ""; return fetch("/pull", { method: "POST", headers: { "Content-Type": "application/json", "x-csrf-token": t }, body: JSON.stringify({ entityType: "<%= c.entityType %>", entityId: "<%= c.entityId %>" }) }).then(r => r.json()).then(() => { try { window.showToast && window.showToast("info", "Pull requested"); } catch {} }); })()'>Manual Pull</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% }) %>
  </div>
<% } %>
